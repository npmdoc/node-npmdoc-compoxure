<div class="apidocDiv">
<style>
/*csslint
*/
.apidocDiv {
    background: #fff;
    font-family: Arial, Helvetica, sans-serif;
}
.apidocDiv a[href] {
    color: #33f;
    font-weight: bold;
    text-decoration: none;
}
.apidocDiv a[href]:hover {
    text-decoration: underline;
}
.apidocCodeCommentSpan {
    background: #bbf;
    color: #000;
    display: block;
}
.apidocCodeKeywordSpan {
    color: #d00;
    font-weight: bold;
}
.apidocCodePre {
    background: #eef;
    border: 1px solid;
    color: #777;
    padding: 5px;
    white-space: pre-wrap;
}
.apidocFooterDiv {
    margin-top: 20px;
    text-align: center;
}
.apidocModuleLi {
    margin-top: 10px;
}
.apidocSectionDiv {
    border-top: 1px solid;
    margin-top: 20px;
}
.apidocSignatureSpan {
    color: #777;
    font-weight: bold;
}
</style>
<h1>api documentation for
    <a

        href="https://github.com/tes/compoxure"

    >compoxure (v2.1.18)</a>
</h1>
<h4>Composition proxy middleware for Express, allows for composition of microservices using declarations and caching.</h4>
<div class="apidocSectionDiv"><a
    href="#apidoc.tableOfContents"
    id="apidoc.tableOfContents"
><h1>table of contents</h1></a><ol>

    <li class="apidocModuleLi"><a href="#apidoc.module.compoxure">module compoxure</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.compoxure.compoxure">
            function <span class="apidocSignatureSpan"></span>compoxure
            <span class="apidocSignatureSpan">(config, eventHandler, optionsTransformer)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">compoxure.</span>htmlparser</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">compoxure.</span>utils</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.compoxure.htmlparser">module compoxure.htmlparser</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.compoxure.htmlparser.getMiddleware">
            function <span class="apidocSignatureSpan">compoxure.htmlparser.</span>getMiddleware
            <span class="apidocSignatureSpan">(config, reliableGet, eventHandler, optionsTransformer)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.compoxure.utils">module compoxure.utils</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.compoxure.utils.cacheKeytoStatsd">
            function <span class="apidocSignatureSpan">compoxure.utils.</span>cacheKeytoStatsd
            <span class="apidocSignatureSpan">(key)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.compoxure.utils.filterCookies">
            function <span class="apidocSignatureSpan">compoxure.utils.</span>filterCookies
            <span class="apidocSignatureSpan">(whitelist, cookies)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.compoxure.utils.formatTemplateVariables">
            function <span class="apidocSignatureSpan">compoxure.utils.</span>formatTemplateVariables
            <span class="apidocSignatureSpan">(variables)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.compoxure.utils.getBackendConfig">
            function <span class="apidocSignatureSpan">compoxure.utils.</span>getBackendConfig
            <span class="apidocSignatureSpan">(config, url, req)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.compoxure.utils.render">
            function <span class="apidocSignatureSpan">compoxure.utils.</span>render
            <span class="apidocSignatureSpan">(text, data)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.compoxure.utils.timeToMillis">
            function <span class="apidocSignatureSpan">compoxure.utils.</span>timeToMillis
            <span class="apidocSignatureSpan">(timeString)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.compoxure.utils.urlToCacheKey">
            function <span class="apidocSignatureSpan">compoxure.utils.</span>urlToCacheKey
            <span class="apidocSignatureSpan">(url)</span>
            </a>

        </li>

    </ol></li>

</ol></div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.compoxure" id="apidoc.module.compoxure">module compoxure</a></h1>


    <h2>
        <a href="#apidoc.element.compoxure.compoxure" id="apidoc.element.compoxure.compoxure">
        function <span class="apidocSignatureSpan"></span>compoxure
        <span class="apidocSignatureSpan">(config, eventHandler, optionsTransformer)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">compoxure = function (config, eventHandler, optionsTransformer) {

  eventHandler = eventHandler || {};
  eventHandler.logger = eventHandler.logger || function() {};
  eventHandler.stats = eventHandler.stats || function() {};

  optionsTransformer = optionsTransformer || function(req, options, next) { next(null, options); };

  var backendProxyMiddleware = require(&#x27;./src/middleware/proxy&#x27;)(config, eventHandler, optionsTransformer);
  var cacheMiddleware = require(&#x27;reliable-get/CacheMiddleware&#x27;)(config);
  var selectBackend = require(&#x27;./src/middleware/backend&#x27;)(config);
  var rejectUnsupportedMediaType = require(&#x27;./src/middleware/mediatypes&#x27;);
  var passThrough = require(&#x27;./src/middleware/passthrough&#x27;)(config);
  var interrogateRequest = require(&#x27;./src/middleware/interrorgator&#x27;)(config, eventHandler);
  var cleanInvalidUri = require(&#x27;./src/middleware/invalidurl&#x27;)(eventHandler);
  var dropFavIcon = require(&#x27;./src/middleware/favicon&#x27;);

  var middleware = ware()
                    .use(cleanInvalidUri)
                    .use(dropFavIcon)
                    .use(cacheMiddleware)
                    .use(interrogateRequest)
                    .use(selectBackend)
                    .use(rejectUnsupportedMediaType)
                    .use(passThrough)
                    .use(cookieParser)
                    .use(bodyParser.text({type: &#x27;text/compoxure&#x27;}))
                    .use(backendProxyMiddleware);

  return function(req, res) {
    middleware.run(req, res, function(err) {
        if(err) {
            // Just end fast - headers sent above if needed.
            res.end(&#x27;&#x27;);
        }
    });
  }

}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>






</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.compoxure.htmlparser" id="apidoc.module.compoxure.htmlparser">module compoxure.htmlparser</a></h1>


    <h2>
        <a href="#apidoc.element.compoxure.htmlparser.getMiddleware" id="apidoc.element.compoxure.htmlparser.getMiddleware">
        function <span class="apidocSignatureSpan">compoxure.htmlparser.</span>getMiddleware
        <span class="apidocSignatureSpan">(config, reliableGet, eventHandler, optionsTransformer)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function getMiddleware(config, reliableGet, eventHandler, optionsTransformer) {
  function getCdnHost() {
    if (config.cdn.host) {
      return config.cdn.host;
    }
  }

  function getCdnUrl() {
    if (config.cdn.url) {
      return config.cdn.url;
    }
  }

  return function parserMiddleware(req, res, cb) {
    var templateVars = req.templateVars;
    var commonState = {}; // common between all parser
    var fragmentTimings = [];

    function getContent(fragment, next) {
      if (!(config.content &#x26;&#x26; config.content.server)) {
        return next(null);
      }

      var tag = getCxAttr(fragment, &#x27;cx-content&#x27;);
      var url = config.content.server + &#x27;/&#x27; + tag;
      var cacheKeyAttr = getCxAttr(fragment, &#x27;cx-cache-key&#x27;);

      var opts = {
        url: url,
        timeout: config.content.timeout || 5000,
        cacheKey: cacheKeyAttr,
        cacheTTL: utils.timeToMillis(getCxAttr(fragment, &#x27;cx-cache-ttl&#x27;, &#x27;1m&#x27;))
      };

      reliableGet.get(opts, function (err, response) {
        if (err) {
          return next(errorTemplate({ err: err.message }));
        }

        var contentVars = {};
        try {
          contentVars = JSON.parse(response.content);
        } catch (e) {
          // Ignore parse error
        }

        _.each(contentVars, function (value, key) {
          templateVars[&#x27;content:&#x27; + tag + &#x27;:&#x27; + key] = value;
          templateVars[&#x27;content:&#x27; + tag + &#x27;:&#x27; + key + &#x27;:encoded&#x27;] = encodeURI(value);
        });

        next(null, &#x27;&#x3c;!-- content &#x27; + tag + &#x27; loaded --&#x3e;&#x27;);
      });
    }

    function getSlot(fragment, next) {
      var slotName = getCxAttr(fragment, &#x27;cx-define-slot&#x27;);
      var content = templateVars.slots[slotName];
      parxer(getParxerOpts(0), content, function (parxerErr, fragmentCount, newContent) {
        if (parxerErr &#x26;&#x26; parxerErr.content) {
          return next(parxerErr, content);
        }
        return next(null, newContent);
      });
    }

    function getCookie() {
      if (req.cookies &#x26;&#x26; req.headers.cookie) {
        var whitelist = config.cookies &#x26;&#x26; config.cookies.whitelist;
        return whitelist ? utils.filterCookies(whitelist, req.cookies) : req.headers.cookie;
      }
    }

    function setResponseHeaders(headers) {
      if (res.headersSent) {
        return; // ignore late joiners
      }

      // A fragment is telling us to not cache it. We force the entire backend/composed page to not be cached.
      var cacheControlHeader = headers[&#x27;cache-control&#x27;];
      if (cacheControlHeader &#x26;&#x26; (cacheControlHeader.indexOf(&#x27;no-cache&#x27;) !== -1 || cacheControlHeader.indexOf(&#x27;no-store&#x27;) !== -1)) {
        // Use the fragment&#x27;s cache-control header only if we don&#x27;t already have one from the backend, or
        // it does not have no-cache or no-store.
        var backendCacheControl = res.getHeader(&#x27;cache-control&#x27;);
        if (!backendCacheControl || (backendCacheControl.indexOf(&#x27;no-cache&#x27;) === -1 &#x26;&#x26; backendCacheControl.indexOf(&#x27;no-store&#x27;) === -
1)) {
          res.setHeader(&#x27;cache-control&#x27;, &#x27;no-cache, no-store, must-revalidate&#x27;);
        }
      }

      if (headers[&#x27;set-cookie&#x27;]) {
        var existingResponseCookies = res.getHeader(&#x27;set-cookie&#x27;) || [];
        res.setHeader(&#x27;set-cookie&#x27;, _.union(existingResponseCookies, headers[&#x27;set-cookie&#x27;]));
      }
    }

    function logError(err, message, ignoreError) {
      var logLevel = (err.statusCode === 404 || ignoreError) ? &#x27;warn&#x27; : &#x27;error&#x27;;

      if (typeof eventHandler.logger === &#x27;function&#x27;) {
        eventHandler.logger(logLevel, message, { tracer: req.tracer });
      }
    }

    function isDebugEnabled() {
      return req.query &#x26;&#x26; req.query[&#x27;cx-debug&#x27;];
    }

    function getParxerOpts(depth) {
      function getCx(fragment, next) {
        var start = Date.now();
        var parseMeTag = hasCxAttr(fragment, &#x27;cx-parse-me&#x27;);
        var url = getCxAttr(fragment, &#x27;cx-url&#x27;);
        var cacheKeyAttr = getCxAttr(fragment, &#x27;cx-cache-key&#x27;);
        var ignoreError = getCxAttr(fragment, &#x27;cx-ignore-error&#x27;);

        function responseCallback(err, content, headers) {
          if (headers) { ...</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var url = require(&#x27;url&#x27;);
var extractSlots = require(&#x27;../extract-slots&#x27;);
var Core = require(&#x27;parxer/lib/core&#x27;);

module.exports = function backendProxyMiddleware(config, eventHandler, optionsTransformer) {

  var reliableGet = new ReliableGet(config),
htmlParserMiddleware = HtmlParserProxy.<span class="apidocCodeKeywordSpan">getMiddleware</span>(config, reliableGet, eventHandler
, optionsTransformer);

  reliableGet.on(&#x27;log&#x27;, eventHandler.logger);
  reliableGet.on(&#x27;stat&#x27;, eventHandler.stats);

  return function (req, res) {

htmlParserMiddleware(req, res, function () {
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.compoxure.utils" id="apidoc.module.compoxure.utils">module compoxure.utils</a></h1>


    <h2>
        <a href="#apidoc.element.compoxure.utils.cacheKeytoStatsd" id="apidoc.element.compoxure.utils.cacheKeytoStatsd">
        function <span class="apidocSignatureSpan">compoxure.utils.</span>cacheKeytoStatsd
        <span class="apidocSignatureSpan">(key)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function cacheKeytoStatsd(key) {
  key = key.replace(/\./g, &#x27;_&#x27;);
  key = key.replace(/-/g, &#x27;_&#x27;);
  key = key.replace(/:/g, &#x27;_&#x27;);
  key = key.replace(/\//g, &#x27;_&#x27;);
  return key;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.compoxure.utils.filterCookies" id="apidoc.element.compoxure.utils.filterCookies">
        function <span class="apidocSignatureSpan">compoxure.utils.</span>filterCookies
        <span class="apidocSignatureSpan">(whitelist, cookies)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function filterCookies(whitelist, cookies) {
  return _.reduce(cookies, function (result, value, key) {
    if (whitelist.length === 0 || _.contains(whitelist, key)) {
      result += result ? &#x27;; &#x27; : &#x27;&#x27;;
      result += key + &#x27;=&#x27; + value;
    }
    return result;
  }, &#x27;&#x27;);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    return next(null, newContent);
  });
}

function getCookie() {
  if (req.cookies &#x26;&#x26; req.headers.cookie) {
    var whitelist = config.cookies &#x26;&#x26; config.cookies.whitelist;
    return whitelist ? utils.<span class="apidocCodeKeywordSpan">filterCookies</span>(whitelist, req.cookies) : req.headers.cookie
;
  }
}

function setResponseHeaders(headers) {
  if (res.headersSent) {
    return; // ignore late joiners
  }
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.compoxure.utils.formatTemplateVariables" id="apidoc.element.compoxure.utils.formatTemplateVariables">
        function <span class="apidocSignatureSpan">compoxure.utils.</span>formatTemplateVariables
        <span class="apidocSignatureSpan">(variables)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function formatTemplateVariables(variables) {
  return _.reduce(variables, function (result, variable, cxKey) {
    if (cxKey.indexOf(&#x27;x-&#x27;) === -1) {
      return result;
    }

    var strippedKey = cxKey.replace(&#x27;x-&#x27;, &#x27;&#x27;);
    var variableKey = strippedKey.split(&#x27;|&#x27;)[0];
    var variableName = strippedKey.replace(variableKey + &#x27;|&#x27;, &#x27;&#x27;);

    result[variableKey + &#x27;:&#x27; + variableName] = variable;
    result[variableKey + &#x27;:&#x27; + variableName + &#x27;:encoded&#x27;] = encodeURI(variable);

    return result;
  }, {});
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
        var parseMeTag = hasCxAttr(fragment, &#x27;cx-parse-me&#x27;);
        var url = getCxAttr(fragment, &#x27;cx-url&#x27;);
        var cacheKeyAttr = getCxAttr(fragment, &#x27;cx-cache-key&#x27;);
        var ignoreError = getCxAttr(fragment, &#x27;cx-ignore-error&#x27;);

        function responseCallback(err, content, headers) {
if (headers) {
  var newTemplateVars = utils.<span class="apidocCodeKeywordSpan">formatTemplateVariables</span>(headers);
  _.assign(templateVars, newTemplateVars);
  setResponseHeaders(headers);
}

if (err || !content) {
  return next(err, content, headers);
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.compoxure.utils.getBackendConfig" id="apidoc.element.compoxure.utils.getBackendConfig">
        function <span class="apidocSignatureSpan">compoxure.utils.</span>getBackendConfig
        <span class="apidocSignatureSpan">(config, url, req)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function getBackendConfig(config, url, req) {
  return _.find(config.backend, function (server) {
    // Then try to match based on pattern in backend Config
    if (server.pattern) {
      return [].concat(server.pattern).some(function (pattern) {
        return new RegExp(pattern).test(url);
      });
    }
    // Finally try to match based on lookup function in backend Config
    if (req &#x26;&#x26; server.fn) { // for layout config I am not passing req !
      if (typeof config.functions[server.fn] == &#x27;function&#x27;) {
        return config.functions[server.fn](req, req.templateVars, server);
      }
    }
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  if (headerBackend.target) {
    req.backend = _.find(config.backend, function (server) {
      if(headerBackend.name &#x26;&#x26; server.name === headerBackend.name) {
        return true;
      }
    });
  } else {
    req.backend = utils.<span class="apidocCodeKeywordSpan">getBackendConfig</span>(config, req.url, req);
  }
}

// If we haven&#x27;t matched but have headers, lets just use these
if (!req.backend &#x26;&#x26; headerBackend.target) {
  req.backend = headerBackend;
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.compoxure.utils.render" id="apidoc.element.compoxure.utils.render">
        function <span class="apidocSignatureSpan">compoxure.utils.</span>render
        <span class="apidocSignatureSpan">(text, data)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function render(text, data) {
    if (!text) { return &#x27;&#x27;; }
    var output = Hogan.compile(text).render(escapeVariables(data));
    return output;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
      }
      return next({
        level: &#x27;warn&#x27;,
        message: &#x27;Backend not found&#x27;
      });
    } else {
      req.backend = _.defaults(_.clone(req.backend), headerBackend, backendDefaults);
      req.backend.target = utils.<span class="apidocCodeKeywordSpan">render</span>(req.backend.target, req.templateVars);
      req.backend.cacheKey = req.backend.cacheKey ? utils.render(req.backend.cacheKey, req.templateVars) : null;
      return next();
    }
  }
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.compoxure.utils.timeToMillis" id="apidoc.element.compoxure.utils.timeToMillis">
        function <span class="apidocSignatureSpan">compoxure.utils.</span>timeToMillis
        <span class="apidocSignatureSpan">(timeString)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function timeToMillis(timeString) {

  var matched = new RegExp(&#x27;(\\d+)(.*)&#x27;).exec(timeString),
    num = matched[1],
    period = matched[2] || &#x27;ms&#x27;,
    value = 0;

  switch (period) {
  case &#x27;s&#x27;:
    value = parseInt(num) * 1000;
    break;
  case &#x27;m&#x27;:
    value = parseInt(num) * 1000 * 60;
    break;
  case &#x27;h&#x27;:
    value = parseInt(num) * 1000 * 60 * 60;
    break;
  case &#x27;d&#x27;:
    value = parseInt(num) * 1000 * 60 * 60 * 24;
    break;
  default:
    value = parseInt(num);
  }

  return value;

}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var url = config.content.server + &#x27;/&#x27; + tag;
var cacheKeyAttr = getCxAttr(fragment, &#x27;cx-cache-key&#x27;);

var opts = {
  url: url,
  timeout: config.content.timeout || 5000,
  cacheKey: cacheKeyAttr,
  cacheTTL: utils.<span class="apidocCodeKeywordSpan">timeToMillis</span>(getCxAttr(fragment, &#x27;cx-cache-ttl&#x27;, &#x27;1m
&#x27;))
};

reliableGet.get(opts, function (err, response) {
  if (err) {
    return next(errorTemplate({ err: err.message }));
  }
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.compoxure.utils.urlToCacheKey" id="apidoc.element.compoxure.utils.urlToCacheKey">
        function <span class="apidocSignatureSpan">compoxure.utils.</span>urlToCacheKey
        <span class="apidocSignatureSpan">(url)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function urlToCacheKey(url) {
  url = url.replace(&#x27;http://&#x27;, &#x27;&#x27;);
  url = cacheKeytoStatsd(url);
  return url;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  errorMsg = _.template(&#x27;FAIL &#x3c;%= url %&#x3e; did not respond in &#x3c;%= timing%&#x3e;, elapsed &#x3c;%= elapsed %&#x3e
;. Reason: &#x27; + err.message);
  logError(err, errorMsg({ url: transformedOptions.url, timing: timing, elapsed: elapsed }));
}

var options = {
  url: url,
  timeout: utils.timeToMillis(getCxAttr(fragment, &#x27;cx-timeout&#x27;, &#x27;5s&#x27;)),
  cacheKey: cacheKeyAttr || utils.<span class="apidocCodeKeywordSpan">urlToCacheKey</span>(url),
  cacheTTL: utils.timeToMillis(getCxAttr(fragment, &#x27;cx-cache-ttl&#x27;, &#x27;1m&#x27;)),
  explicitNoCache: req.explicitNoCache || getNoCacheAttr(fragment),
  ignore404: getCxAttr(fragment, &#x27;cx-ignore-404&#x27;, &#x27;true&#x27;) === &#x27;true&#x27;,
  type: &#x27;fragment&#x27;,
  tracer: req.tracer,
  statsdKey: &#x27;fragment_&#x27; + getCxAttr(fragment, &#x27;cx-statsd-key&#x27;, &#x27;unknown&#x27;),
  headers: {
...</pre></li>
    </ul>


</div>

<div class="apidocFooterDiv">
    [ this document was created with
    <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a>
    ]
</div>
</div>
