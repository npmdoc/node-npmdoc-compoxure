<html><head></head><body><div class="apidocDiv">
<style>
/*csslint
*/
.apidocDiv {
    background: #fff;
    font-family: Arial, Helvetica, sans-serif;
}
.apidocDiv a[href] {
    color: #33f;
    font-weight: bold;
    text-decoration: none;
}
.apidocDiv a[href]:hover {
    text-decoration: underline;
}
.apidocCodeCommentSpan {
    background: #bbf;
    color: #000;
    display: block;
}
.apidocCodeKeywordSpan {
    color: #d00;
    font-weight: bold;
}
.apidocCodePre {
    background: #eef;
    border: 1px solid;
    color: #777;
    padding: 5px;
    white-space: pre-wrap;
}
.apidocFooterDiv {
    margin-top: 20px;
    text-align: center;
}
.apidocModuleLi {
    margin-top: 10px;
}
.apidocSectionDiv {
    border-top: 1px solid;
    margin-top: 20px;
}
.apidocSignatureSpan {
    color: #777;
    font-weight: bold;
}
</style>
<h1>api documentation for
    <a href="https://github.com/tes/compoxure">compoxure (v2.1.18)</a>
</h1>
<h4>Composition proxy middleware for Express, allows for composition of microservices using declarations and caching.</h4>
<div class="apidocSectionDiv"><a href="#apidoc.tableOfContents" id="apidoc.tableOfContents"><h1>table of contents</h1></a><ol>

    <li class="apidocModuleLi"><a href="#apidoc.module.compoxure">module compoxure</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.compoxure.compoxure">
            function <span class="apidocSignatureSpan"></span>compoxure
            <span class="apidocSignatureSpan">(config, eventHandler, optionsTransformer)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">compoxure.</span>htmlparser</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">compoxure.</span>utils</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.compoxure.htmlparser">module compoxure.htmlparser</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.compoxure.htmlparser.getMiddleware">
            function <span class="apidocSignatureSpan">compoxure.htmlparser.</span>getMiddleware
            <span class="apidocSignatureSpan">(config, reliableGet, eventHandler, optionsTransformer)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.compoxure.utils">module compoxure.utils</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.compoxure.utils.cacheKeytoStatsd">
            function <span class="apidocSignatureSpan">compoxure.utils.</span>cacheKeytoStatsd
            <span class="apidocSignatureSpan">(key)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.compoxure.utils.filterCookies">
            function <span class="apidocSignatureSpan">compoxure.utils.</span>filterCookies
            <span class="apidocSignatureSpan">(whitelist, cookies)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.compoxure.utils.formatTemplateVariables">
            function <span class="apidocSignatureSpan">compoxure.utils.</span>formatTemplateVariables
            <span class="apidocSignatureSpan">(variables)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.compoxure.utils.getBackendConfig">
            function <span class="apidocSignatureSpan">compoxure.utils.</span>getBackendConfig
            <span class="apidocSignatureSpan">(config, url, req)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.compoxure.utils.render">
            function <span class="apidocSignatureSpan">compoxure.utils.</span>render
            <span class="apidocSignatureSpan">(text, data)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.compoxure.utils.timeToMillis">
            function <span class="apidocSignatureSpan">compoxure.utils.</span>timeToMillis
            <span class="apidocSignatureSpan">(timeString)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.compoxure.utils.urlToCacheKey">
            function <span class="apidocSignatureSpan">compoxure.utils.</span>urlToCacheKey
            <span class="apidocSignatureSpan">(url)</span>
            </a>

        </li>

    </ol></li>

</ol></div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.compoxure" id="apidoc.module.compoxure">module compoxure</a></h1>


    <h2>
        <a href="#apidoc.element.compoxure.compoxure" id="apidoc.element.compoxure.compoxure">
        function <span class="apidocSignatureSpan"></span>compoxure
        <span class="apidocSignatureSpan">(config, eventHandler, optionsTransformer)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">compoxure = function (config, eventHandler, optionsTransformer) {

  eventHandler = eventHandler || {};
  eventHandler.logger = eventHandler.logger || function() {};
  eventHandler.stats = eventHandler.stats || function() {};

  optionsTransformer = optionsTransformer || function(req, options, next) { next(null, options); };

  var backendProxyMiddleware = require('./src/middleware/proxy')(config, eventHandler, optionsTransformer);
  var cacheMiddleware = require('reliable-get/CacheMiddleware')(config);
  var selectBackend = require('./src/middleware/backend')(config);
  var rejectUnsupportedMediaType = require('./src/middleware/mediatypes');
  var passThrough = require('./src/middleware/passthrough')(config);
  var interrogateRequest = require('./src/middleware/interrorgator')(config, eventHandler);
  var cleanInvalidUri = require('./src/middleware/invalidurl')(eventHandler);
  var dropFavIcon = require('./src/middleware/favicon');

  var middleware = ware()
                    .use(cleanInvalidUri)
                    .use(dropFavIcon)
                    .use(cacheMiddleware)
                    .use(interrogateRequest)
                    .use(selectBackend)
                    .use(rejectUnsupportedMediaType)
                    .use(passThrough)
                    .use(cookieParser)
                    .use(bodyParser.text({type: 'text/compoxure'}))
                    .use(backendProxyMiddleware);

  return function(req, res) {
    middleware.run(req, res, function(err) {
        if(err) {
            // Just end fast - headers sent above if needed.
            res.end('');
        }
    });
  }

}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>






</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.compoxure.htmlparser" id="apidoc.module.compoxure.htmlparser">module compoxure.htmlparser</a></h1>


    <h2>
        <a href="#apidoc.element.compoxure.htmlparser.getMiddleware" id="apidoc.element.compoxure.htmlparser.getMiddleware">
        function <span class="apidocSignatureSpan">compoxure.htmlparser.</span>getMiddleware
        <span class="apidocSignatureSpan">(config, reliableGet, eventHandler, optionsTransformer)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function getMiddleware(config, reliableGet, eventHandler, optionsTransformer) {
  function getCdnHost() {
    if (config.cdn.host) {
      return config.cdn.host;
    }
  }

  function getCdnUrl() {
    if (config.cdn.url) {
      return config.cdn.url;
    }
  }

  return function parserMiddleware(req, res, cb) {
    var templateVars = req.templateVars;
    var commonState = {}; // common between all parser
    var fragmentTimings = [];

    function getContent(fragment, next) {
      if (!(config.content &amp;&amp; config.content.server)) {
        return next(null);
      }

      var tag = getCxAttr(fragment, 'cx-content');
      var url = config.content.server + '/' + tag;
      var cacheKeyAttr = getCxAttr(fragment, 'cx-cache-key');

      var opts = {
        url: url,
        timeout: config.content.timeout || 5000,
        cacheKey: cacheKeyAttr,
        cacheTTL: utils.timeToMillis(getCxAttr(fragment, 'cx-cache-ttl', '1m'))
      };

      reliableGet.get(opts, function (err, response) {
        if (err) {
          return next(errorTemplate({ err: err.message }));
        }

        var contentVars = {};
        try {
          contentVars = JSON.parse(response.content);
        } catch (e) {
          // Ignore parse error
        }

        _.each(contentVars, function (value, key) {
          templateVars['content:' + tag + ':' + key] = value;
          templateVars['content:' + tag + ':' + key + ':encoded'] = encodeURI(value);
        });

        next(null, '&lt;!-- content ' + tag + ' loaded --&gt;');
      });
    }

    function getSlot(fragment, next) {
      var slotName = getCxAttr(fragment, 'cx-define-slot');
      var content = templateVars.slots[slotName];
      parxer(getParxerOpts(0), content, function (parxerErr, fragmentCount, newContent) {
        if (parxerErr &amp;&amp; parxerErr.content) {
          return next(parxerErr, content);
        }
        return next(null, newContent);
      });
    }

    function getCookie() {
      if (req.cookies &amp;&amp; req.headers.cookie) {
        var whitelist = config.cookies &amp;&amp; config.cookies.whitelist;
        return whitelist ? utils.filterCookies(whitelist, req.cookies) : req.headers.cookie;
      }
    }

    function setResponseHeaders(headers) {
      if (res.headersSent) {
        return; // ignore late joiners
      }

      // A fragment is telling us to not cache it. We force the entire backend/composed page to not be cached.
      var cacheControlHeader = headers['cache-control'];
      if (cacheControlHeader &amp;&amp; (cacheControlHeader.indexOf('no-cache') !== -1 || cacheControlHeader.indexOf('no-store') !== -1)) {
        // Use the fragment's cache-control header only if we don't already have one from the backend, or
        // it does not have no-cache or no-store.
        var backendCacheControl = res.getHeader('cache-control');
        if (!backendCacheControl || (backendCacheControl.indexOf('no-cache') === -1 &amp;&amp; backendCacheControl.indexOf('no-store') === -
1)) {
          res.setHeader('cache-control', 'no-cache, no-store, must-revalidate');
        }
      }

      if (headers['set-cookie']) {
        var existingResponseCookies = res.getHeader('set-cookie') || [];
        res.setHeader('set-cookie', _.union(existingResponseCookies, headers['set-cookie']));
      }
    }

    function logError(err, message, ignoreError) {
      var logLevel = (err.statusCode === 404 || ignoreError) ? 'warn' : 'error';

      if (typeof eventHandler.logger === 'function') {
        eventHandler.logger(logLevel, message, { tracer: req.tracer });
      }
    }

    function isDebugEnabled() {
      return req.query &amp;&amp; req.query['cx-debug'];
    }

    function getParxerOpts(depth) {
      function getCx(fragment, next) {
        var start = Date.now();
        var parseMeTag = hasCxAttr(fragment, 'cx-parse-me');
        var url = getCxAttr(fragment, 'cx-url');
        var cacheKeyAttr = getCxAttr(fragment, 'cx-cache-key');
        var ignoreError = getCxAttr(fragment, 'cx-ignore-error');

        function responseCallback(err, content, headers) {
          if (headers) { ...</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var url = require('url');
var extractSlots = require('../extract-slots');
var Core = require('parxer/lib/core');

module.exports = function backendProxyMiddleware(config, eventHandler, optionsTransformer) {

  var reliableGet = new ReliableGet(config),
htmlParserMiddleware = HtmlParserProxy.<span class="apidocCodeKeywordSpan">getMiddleware</span>(config, reliableGet, eventHandler
, optionsTransformer);

  reliableGet.on('log', eventHandler.logger);
  reliableGet.on('stat', eventHandler.stats);

  return function (req, res) {

htmlParserMiddleware(req, res, function () {
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.compoxure.utils" id="apidoc.module.compoxure.utils">module compoxure.utils</a></h1>


    <h2>
        <a href="#apidoc.element.compoxure.utils.cacheKeytoStatsd" id="apidoc.element.compoxure.utils.cacheKeytoStatsd">
        function <span class="apidocSignatureSpan">compoxure.utils.</span>cacheKeytoStatsd
        <span class="apidocSignatureSpan">(key)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function cacheKeytoStatsd(key) {
  key = key.replace(/\./g, '_');
  key = key.replace(/-/g, '_');
  key = key.replace(/:/g, '_');
  key = key.replace(/\//g, '_');
  return key;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.compoxure.utils.filterCookies" id="apidoc.element.compoxure.utils.filterCookies">
        function <span class="apidocSignatureSpan">compoxure.utils.</span>filterCookies
        <span class="apidocSignatureSpan">(whitelist, cookies)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function filterCookies(whitelist, cookies) {
  return _.reduce(cookies, function (result, value, key) {
    if (whitelist.length === 0 || _.contains(whitelist, key)) {
      result += result ? '; ' : '';
      result += key + '=' + value;
    }
    return result;
  }, '');
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    return next(null, newContent);
  });
}

function getCookie() {
  if (req.cookies &amp;&amp; req.headers.cookie) {
    var whitelist = config.cookies &amp;&amp; config.cookies.whitelist;
    return whitelist ? utils.<span class="apidocCodeKeywordSpan">filterCookies</span>(whitelist, req.cookies) : req.headers.cookie
;
  }
}

function setResponseHeaders(headers) {
  if (res.headersSent) {
    return; // ignore late joiners
  }
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.compoxure.utils.formatTemplateVariables" id="apidoc.element.compoxure.utils.formatTemplateVariables">
        function <span class="apidocSignatureSpan">compoxure.utils.</span>formatTemplateVariables
        <span class="apidocSignatureSpan">(variables)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function formatTemplateVariables(variables) {
  return _.reduce(variables, function (result, variable, cxKey) {
    if (cxKey.indexOf('x-') === -1) {
      return result;
    }

    var strippedKey = cxKey.replace('x-', '');
    var variableKey = strippedKey.split('|')[0];
    var variableName = strippedKey.replace(variableKey + '|', '');

    result[variableKey + ':' + variableName] = variable;
    result[variableKey + ':' + variableName + ':encoded'] = encodeURI(variable);

    return result;
  }, {});
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
        var parseMeTag = hasCxAttr(fragment, 'cx-parse-me');
        var url = getCxAttr(fragment, 'cx-url');
        var cacheKeyAttr = getCxAttr(fragment, 'cx-cache-key');
        var ignoreError = getCxAttr(fragment, 'cx-ignore-error');

        function responseCallback(err, content, headers) {
if (headers) {
  var newTemplateVars = utils.<span class="apidocCodeKeywordSpan">formatTemplateVariables</span>(headers);
  _.assign(templateVars, newTemplateVars);
  setResponseHeaders(headers);
}

if (err || !content) {
  return next(err, content, headers);
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.compoxure.utils.getBackendConfig" id="apidoc.element.compoxure.utils.getBackendConfig">
        function <span class="apidocSignatureSpan">compoxure.utils.</span>getBackendConfig
        <span class="apidocSignatureSpan">(config, url, req)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function getBackendConfig(config, url, req) {
  return _.find(config.backend, function (server) {
    // Then try to match based on pattern in backend Config
    if (server.pattern) {
      return [].concat(server.pattern).some(function (pattern) {
        return new RegExp(pattern).test(url);
      });
    }
    // Finally try to match based on lookup function in backend Config
    if (req &amp;&amp; server.fn) { // for layout config I am not passing req !
      if (typeof config.functions[server.fn] == 'function') {
        return config.functions[server.fn](req, req.templateVars, server);
      }
    }
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  if (headerBackend.target) {
    req.backend = _.find(config.backend, function (server) {
      if(headerBackend.name &amp;&amp; server.name === headerBackend.name) {
        return true;
      }
    });
  } else {
    req.backend = utils.<span class="apidocCodeKeywordSpan">getBackendConfig</span>(config, req.url, req);
  }
}

// If we haven't matched but have headers, lets just use these
if (!req.backend &amp;&amp; headerBackend.target) {
  req.backend = headerBackend;
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.compoxure.utils.render" id="apidoc.element.compoxure.utils.render">
        function <span class="apidocSignatureSpan">compoxure.utils.</span>render
        <span class="apidocSignatureSpan">(text, data)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function render(text, data) {
    if (!text) { return ''; }
    var output = Hogan.compile(text).render(escapeVariables(data));
    return output;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
      }
      return next({
        level: 'warn',
        message: 'Backend not found'
      });
    } else {
      req.backend = _.defaults(_.clone(req.backend), headerBackend, backendDefaults);
      req.backend.target = utils.<span class="apidocCodeKeywordSpan">render</span>(req.backend.target, req.templateVars);
      req.backend.cacheKey = req.backend.cacheKey ? utils.render(req.backend.cacheKey, req.templateVars) : null;
      return next();
    }
  }
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.compoxure.utils.timeToMillis" id="apidoc.element.compoxure.utils.timeToMillis">
        function <span class="apidocSignatureSpan">compoxure.utils.</span>timeToMillis
        <span class="apidocSignatureSpan">(timeString)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function timeToMillis(timeString) {

  var matched = new RegExp('(\\d+)(.*)').exec(timeString),
    num = matched[1],
    period = matched[2] || 'ms',
    value = 0;

  switch (period) {
  case 's':
    value = parseInt(num) * 1000;
    break;
  case 'm':
    value = parseInt(num) * 1000 * 60;
    break;
  case 'h':
    value = parseInt(num) * 1000 * 60 * 60;
    break;
  case 'd':
    value = parseInt(num) * 1000 * 60 * 60 * 24;
    break;
  default:
    value = parseInt(num);
  }

  return value;

}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var url = config.content.server + '/' + tag;
var cacheKeyAttr = getCxAttr(fragment, 'cx-cache-key');

var opts = {
  url: url,
  timeout: config.content.timeout || 5000,
  cacheKey: cacheKeyAttr,
  cacheTTL: utils.<span class="apidocCodeKeywordSpan">timeToMillis</span>(getCxAttr(fragment, 'cx-cache-ttl', '1m
'))
};

reliableGet.get(opts, function (err, response) {
  if (err) {
    return next(errorTemplate({ err: err.message }));
  }
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.compoxure.utils.urlToCacheKey" id="apidoc.element.compoxure.utils.urlToCacheKey">
        function <span class="apidocSignatureSpan">compoxure.utils.</span>urlToCacheKey
        <span class="apidocSignatureSpan">(url)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function urlToCacheKey(url) {
  url = url.replace('http://', '');
  url = cacheKeytoStatsd(url);
  return url;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  errorMsg = _.template('FAIL &lt;%= url %&gt; did not respond in &lt;%= timing%&gt;, elapsed &lt;%= elapsed %&gt;
;. Reason: ' + err.message);
  logError(err, errorMsg({ url: transformedOptions.url, timing: timing, elapsed: elapsed }));
}

var options = {
  url: url,
  timeout: utils.timeToMillis(getCxAttr(fragment, 'cx-timeout', '5s')),
  cacheKey: cacheKeyAttr || utils.<span class="apidocCodeKeywordSpan">urlToCacheKey</span>(url),
  cacheTTL: utils.timeToMillis(getCxAttr(fragment, 'cx-cache-ttl', '1m')),
  explicitNoCache: req.explicitNoCache || getNoCacheAttr(fragment),
  ignore404: getCxAttr(fragment, 'cx-ignore-404', 'true') === 'true',
  type: 'fragment',
  tracer: req.tracer,
  statsdKey: 'fragment_' + getCxAttr(fragment, 'cx-statsd-key', 'unknown'),
  headers: {
...</pre></li>
    </ul>


</div>

<div class="apidocFooterDiv">
    [ this document was created with
    <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a>
    ]
</div>
</div>
</body></html>